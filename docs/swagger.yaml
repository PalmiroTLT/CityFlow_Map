openapi: 3.0.3
info:
  title: Retro City Map API
  description: |
    API для интерактивной карты города с местами, турами и премиум-контентом.
    
    ## Аутентификация
    Большинство запросов требуют JWT токен в заголовке Authorization:
    ```
    Authorization: Bearer <your-jwt-token>
    ```
    
    ## Базовый URL
    ```
    https://vjegrpjzhtyrihhpjpzz.supabase.co/functions/v1
    ```
  version: 2.0.0
  contact:
    name: API Support
    email: support@retrocitymap.com

servers:
  - url: https://vjegrpjzhtyrihhpjpzz.supabase.co/functions/v1
    description: Production server (External Supabase)

tags:
  - name: Places
    description: Управление местами на карте
  - name: Tours
    description: Управление турами
  - name: Premium
    description: Премиум функции и подписки
  - name: Notifications
    description: Push-уведомления
  - name: Communication
    description: Email и переводы
  - name: Webhooks
    description: Внутренние webhooks

security:
  - BearerAuth: []

paths:
  /add-place:
    post:
      tags:
        - Places
      summary: Добавить новое место
      description: |
        Добавляет новое место на карту. Доступно только для бизнес-пользователей.
        
        **Стоимость:** 15 кредитов
        
        **Требования:**
        - Пользователь должен быть аутентифицирован
        - Тип пользователя должен быть 'business'
        - На балансе должно быть минимум 15 кредитов
      operationId: addPlace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddPlaceRequest'
      responses:
        '200':
          description: Место успешно добавлено
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /add-place-with-subscription:
    post:
      tags:
        - Places
        - Premium
      summary: Добавить место с подпиской
      description: |
        Создает место и автоматически оформляет подписку на выбранный план.
        
        **Требования:**
        - Бизнес-аккаунт
        - Достаточно кредитов для первого платежа
      operationId: addPlaceWithSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/AddPlaceRequest'
                - type: object
                  required:
                    - subscription_plan_id
                  properties:
                    subscription_plan_id:
                      type: string
                      format: uuid
                      description: ID плана подписки
      responses:
        '200':
          description: Место и подписка созданы
          content:
            application/json:
              schema:
                type: object
                properties:
                  place:
                    type: object
                  subscription:
                    type: object
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/InsufficientCredits'

  /toggle-premium:
    post:
      tags:
        - Premium
      summary: Переключить премиум статус места
      description: |
        Активирует или деактивирует премиум статус места.
        
        **Стоимость активации:** 8 кредитов
        **Период:** 30 дней
      operationId: togglePremium
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - placeId
                - isPremium
              properties:
                placeId:
                  type: string
                  format: uuid
                isPremium:
                  type: boolean
      responses:
        '200':
          description: Статус успешно изменён
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /purchase-tour:
    post:
      tags:
        - Tours
      summary: Купить тур
      description: |
        Покупает тур за кредиты. После покупки тур становится доступным пользователю.
        
        **Стоимость:** 10 кредитов
      operationId: purchaseTour
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tourId
              properties:
                tourId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Тур успешно куплен
        '400':
          description: Тур уже куплен или не найден
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/InsufficientCredits'

  /translate-text:
    post:
      tags:
        - Communication
      summary: Перевести текст
      description: |
        Переводит текст на указанный язык используя Lovable AI.
        
        **Поддерживаемые языки:** en, ru, sr
      operationId: translateText
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text
                - targetLanguage
              properties:
                text:
                  type: string
                  description: Текст для перевода
                targetLanguage:
                  type: string
                  enum: [en, ru, sr]
                  description: Целевой язык
      responses:
        '200':
          description: Текст успешно переведен
          content:
            application/json:
              schema:
                type: object
                properties:
                  translatedText:
                    type: string
        '400':
          $ref: '#/components/responses/ValidationError'

  /send-custom-email:
    post:
      tags:
        - Communication
      summary: Отправить кастомный email
      description: |
        Отправляет email с использованием кастомных шаблонов через Brevo.
        
        **Типы email:**
        - signup_confirmation
        - password_reset
        - email_change
      operationId: sendCustomEmail
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user
                - email_data
              properties:
                user:
                  type: object
                  properties:
                    email:
                      type: string
                    user_metadata:
                      type: object
                      properties:
                        language:
                          type: string
                email_data:
                  type: object
                  properties:
                    email_action_type:
                      type: string
                    token:
                      type: string
                    redirect_to:
                      type: string
      responses:
        '200':
          description: Email отправлен
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          description: Ошибка отправки email

  /send-push-notification:
    post:
      tags:
        - Notifications
      summary: Отправить push-уведомление
      description: |
        Отправляет push-уведомление всем подписанным пользователям или тестовому пользователю.
      operationId: sendPushNotification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - body
              properties:
                title:
                  type: string
                body:
                  type: string
                data:
                  type: object
                isTest:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Уведомления отправлены
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  successfulCount:
                    type: integer
                  failedCount:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Только для администраторов

  /get-vapid-key:
    get:
      tags:
        - Notifications
      summary: Получить публичный VAPID ключ
      description: |
        Возвращает публичный VAPID ключ для подписки на push-уведомления.
      operationId: getVapidKey
      security: []
      responses:
        '200':
          description: VAPID ключ
          content:
            application/json:
              schema:
                type: object
                properties:
                  publicKey:
                    type: string

  /notify-new-place-webhook:
    post:
      tags:
        - Webhooks
      summary: Webhook для уведомлений о новых местах
      description: |
        Внутренний webhook, вызываемый триггером БД при добавлении нового места.
        Отправляет push-уведомления всем подписанным пользователям.
        
        **Требует X-Webhook-Secret заголовок**
      operationId: notifyNewPlaceWebhook
      security: []
      parameters:
        - name: X-Webhook-Secret
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - body
              properties:
                title:
                  type: string
                body:
                  type: string
                data:
                  type: object
      responses:
        '200':
          description: Уведомления отправлены

  /process-scheduled-notifications:
    post:
      tags:
        - Notifications
      summary: Обработать запланированные уведомления
      description: |
        Cron-функция для обработки запланированных уведомлений.
        Вызывается автоматически по расписанию.
      operationId: processScheduledNotifications
      security: []
      responses:
        '200':
          description: Уведомления обработаны

  /process-subscriptions:
    post:
      tags:
        - Premium
      summary: Обработать подписки
      description: |
        Cron-функция для обработки платежей по подпискам.
        Вызывается автоматически по расписанию.
      operationId: processSubscriptions
      security: []
      responses:
        '200':
          description: Подписки обработаны

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен из Supabase Auth

  schemas:
    AddPlaceRequest:
      type: object
      required:
        - name
        - latitude
        - longitude
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        name_en:
          type: string
          maxLength: 200
        name_sr:
          type: string
          maxLength: 200
        description:
          type: string
          maxLength: 1000
        description_en:
          type: string
          maxLength: 1000
        description_sr:
          type: string
          maxLength: 1000
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
        category_id:
          type: string
          format: uuid
        city_id:
          type: string
          format: uuid
        address:
          type: string
          maxLength: 500
        phone:
          type: string
          maxLength: 50
        website:
          type: string
          format: uri
          maxLength: 500
        google_maps_url:
          type: string
          format: uri
          maxLength: 500
        image_url:
          type: string
          format: uri
          maxLength: 500
        custom_button_text:
          type: string
          maxLength: 100
        custom_button_url:
          type: string
          format: uri
          maxLength: 500

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        details:
          type: string

  responses:
    Unauthorized:
      description: Не авторизован
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Unauthorized"

    Forbidden:
      description: Недостаточно прав
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Access denied"

    InsufficientCredits:
      description: Недостаточно кредитов
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Insufficient credits"

    ValidationError:
      description: Ошибка валидации данных
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Validation failed"
            details: "Missing required field: name"