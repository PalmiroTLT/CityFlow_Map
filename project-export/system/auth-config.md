# Authentication Configuration

## Overview
This document describes the authentication configuration required for the Retro City Map project.

---

## Auth Providers

### Email/Password Authentication
**Status**: Enabled (Primary method)

**Configuration**:
- **Enable Email provider**: Yes
- **Confirm email**: Recommended to disable for development/testing
- **Secure email change**: Enabled
- **Secure password change**: Enabled (requires email verification)

**Email Templates**: See `email-templates/` folder for custom templates

---

## Redirect URLs

### Allowed Redirect URLs
Add these URLs to your Supabase project's Authentication → URL Configuration:

**Production**:
```
https://your-production-domain.com
https://your-production-domain.com/**
```

**Development**:
```
http://localhost:5173
http://localhost:5173/**
http://127.0.0.1:5173
http://127.0.0.1:5173/**
```

**Lovable Cloud Preview** (if applicable):
```
https://*.lovable.app
https://*.lovable.app/**
```

### Site URL
Set your primary site URL in Authentication → URL Configuration:
```
https://your-production-domain.com
```

---

## SMTP Configuration (Brevo)

### Email Service Provider
- **Provider**: Brevo (Sendinblue)
- **Why**: Free tier (300 emails/day), reliable transactional emails

### SMTP Settings
Go to: Authentication → Email → SMTP Settings

**Enable Custom SMTP**: Yes

**SMTP Configuration**:
```
Host: smtp-relay.brevo.com
Port: 587
Username: Your Brevo SMTP username
Password: Your Brevo SMTP password (from API keys)
Sender email: noreply@your-domain.com
Sender name: Retro City Map
```

**How to get Brevo credentials**:
1. Sign up at https://brevo.com
2. Go to Settings → SMTP & API → SMTP
3. Create SMTP credentials
4. Verify your sender domain

---

## Email Templates

### Custom Templates Required
The project uses custom email templates for all auth emails. Templates are multilingual (SR/RU/EN) and stored in the `email_templates` table.

**Template Types**:
1. `signup` - Email verification
2. `recovery` - Password reset
3. `magic_link` - Magic link login (if enabled)
4. `email_change` - Email change confirmation

### Template Variables
All templates support these variables:
- `{{ .Token }}` - Verification token
- `{{ .TokenHash }}` - Token hash
- `{{ .SiteURL }}` - Your site URL
- `{{ .RedirectTo }}` - Redirect URL after confirmation
- `{{ .Email }}` - User's email address

### Applying Templates
Templates are applied via Auth Hooks (see below).

---

## Auth Hooks Configuration

### Overview
Auth Hooks allow custom email handling through Edge Functions.

**Required Hook**: `send_email`

### Setup Instructions

1. **Enable Auth Hooks** in Supabase Dashboard:
   - Go to Authentication → Hooks
   - Enable "Send Email" hook

2. **Configure Hook**:
   - **Function**: `send-custom-email`
   - **Schema**: `public`
   - **Events**: All email events (signup, recovery, email_change)

3. **Hook Function**:
   The `send-custom-email` edge function handles:
   - Loading email templates from database
   - Selecting correct language based on user profile
   - Rendering template with variables
   - Sending via Brevo API

### Hook Configuration JSON
```json
{
  "enabled": true,
  "hook_name": "send_email",
  "hook_table_id": null,
  "hook_table_name": null,
  "function_name": "send-custom-email",
  "function_schema": "public",
  "events": ["INSERT", "UPDATE"]
}
```

---

## Token Settings

### JWT Settings
- **JWT expiry**: 3600 seconds (1 hour)
- **Refresh token expiry**: 2592000 seconds (30 days)
- **JWT Secret**: Auto-generated by Supabase

### Password Requirements
Configure in Authentication → Policies:
- **Minimum password length**: 6 characters
- **Require uppercase**: No
- **Require lowercase**: No
- **Require numbers**: No
- **Require special characters**: No

*Note: Adjust as needed for production security*

---

## Session Management

### Session Configuration
- **Enable refresh token rotation**: Yes
- **Reuse interval**: 10 seconds
- **Auto-refresh token**: Yes (handled by supabase-js)

---

## Security Settings

### Rate Limiting
- **Email rate limit**: 4 requests per hour per email
- **SMS rate limit**: N/A (not used)

### Additional Security
- **Enable Captcha**: Optional (recommended for production)
- **Email OTP**: Disabled
- **Phone auth**: Disabled

---

## User Management

### Default User Metadata
When users sign up, metadata is captured:
```json
{
  "full_name": "User's full name",
  "user_type": "individual" | "business",
  "country_id": "uuid",
  "city_id": "uuid"
}
```

This metadata is used to populate the `profiles` table via the `handle_new_user()` trigger.

### User Roles
Roles are assigned via `user_roles` table:
- **Default role**: `user`
- **Admin email**: `qwe@qwe.qwe` (auto-assigned admin role)
- **Role management**: Admins can assign roles via admin panel

---

## Testing Configuration

### For Development/Testing
1. **Disable email confirmation**:
   - Go to Authentication → Providers → Email
   - Uncheck "Confirm email"
   - This allows instant login without email verification

2. **Use test email addresses**:
   - Create test users with `+tag` emails: `test+1@example.com`

3. **Check email logs**:
   - Authentication → Logs → Email logs

---

## Troubleshooting

### Emails not sending
1. Check SMTP credentials in Authentication → Email → SMTP Settings
2. Verify sender domain in Brevo
3. Check Brevo daily limit (300 emails/day on free tier)
4. Review Edge Function logs: `send-custom-email`

### Users can't sign up
1. Check if email confirmation is required
2. Verify Auth Hook is configured correctly
3. Check Edge Function logs for errors
4. Verify `email_templates` table has required templates

### Password reset not working
1. Verify SMTP configuration
2. Check redirect URLs include password reset page
3. Verify `recovery` email template exists
4. Check Edge Function logs

---

## Migration Checklist

- [ ] Enable Email/Password provider
- [ ] Configure redirect URLs (production + development)
- [ ] Set up Brevo SMTP credentials
- [ ] Configure Auth Hook for `send_email`
- [ ] Deploy `send-custom-email` Edge Function
- [ ] Populate `email_templates` table with templates
- [ ] Test signup flow
- [ ] Test password recovery
- [ ] Test email change (if enabled)
- [ ] Configure rate limiting
- [ ] Set password requirements
- [ ] Enable captcha (optional, for production)
